name: Build PMTiles (Bosque La Primavera)

on:
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bounds & zoom
        run: |
          echo "WEST=-104.00"  >> $GITHUB_ENV
          echo "SOUTH=20.30"   >> $GITHUB_ENV
          echo "EAST=-103.20"  >> $GITHUB_ENV
          echo "NORTH=20.95"   >> $GITHUB_ENV
          echo "MIN_ZOOM=10"   >> $GITHUB_ENV
          echo "MAX_ZOOM=14"   >> $GITHUB_ENV   # <-- súbelo/bájalo aquí


      - name: Build PMTiles with Planetiler (Docker)
        env:
          JAVA_TOOL_OPTIONS: "-Xms1g -Xmx6g"
        run: |
          docker run --rm -e JAVA_TOOL_OPTIONS -v "$PWD":/data ghcr.io/onthegomap/planetiler:latest \
            --bounds=$WEST,$SOUTH,$EAST,$NORTH \
            --download \
            --min-zoom=$MIN_ZOOM \
            --max-zoom=$MAX_ZOOM \
            --output=/data/primavera.pmtiles \
            --force

      - name: List output
        run: ls -lh

      # Falla si el archivo es demasiado pequeño (indicio de error)
      - name: Validate size
        run: |
          BYTES=$(stat -c%s "primavera.pmtiles" || stat -f%z "primavera.pmtiles")
          echo "File size: $BYTES bytes"
          # exige al menos 5 MB (ajusta si hace falta)
          if [ "$BYTES" -lt 5000000 ]; then
            echo "PMTiles too small -> generation failed."
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: primavera.pmtiles
          path: primavera.pmtiles
          if-no-files-found: error

